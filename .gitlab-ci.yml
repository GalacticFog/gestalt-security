stages:
- test
- publish
- deploy

cache:
  key: "$CI_PIPELINE_ID"
  untracked: true

variables:
  POSTGRES_DB: gestalt-security
  POSTGRES_USER: gestaltdev
  POSTGRES_PASSWORD: letmein
  DATABASE_HOSTNAME: postgres
  DATABASE_NAME: gestalt-security
  DATABASE_PORT: "5432"
  DATABASE_USERNAME: gestaltdev
  DATABASE_PASSWORD: letmein
  ROOT_USERNAME: root
  ROOT_PASSWORD: letmein
  TEST_LDAP_URL: "ldap://galacticfog__test-ldap:389"
  TEST_LDAP_USER: admin
  TEST_LDAP_PASS: password
  DOCKER_IMG: "galacticfog.artifactoryonline.com/gestalt-security"

test:
  stage: test
  services:
    - postgres:9.4
    - galacticfog/test-ldap:0.1.0
  script:
    - ./activator clean update test docker:stage

publish-branch:
  stage: publish
  script: 
    - export VERSION=$(grep "^version" build.sbt | sed 's/.*:=[ ]*//' | sed 's/"//g')
    - export DOCKER_TAG=$VERSION-${CI_BUILD_REF:0:8}
    - env
    - cd target/docker/stage
    - docker build -t $DOCKER_IMG:$DOCKER_TAG
    - docker push     $DOCKER_IMG:$DOCKER_TAG
  only:
    - branches

publish-tag: 
  stage: publish
  script:
    - cd target/docker/stage
    - docker build -t $DOCKER_IMG:$CI_BUILD_TAG
    - docker push     $DOCKER_IMG:$CI_BUILD_TAG
  only:
    - tags

deploy-to-test:
  stage: deploy
  environment: test
  script: 
    - echo checking for access to marathon
    - curl http://marathon.mesos:8080/v2/apps/gestalt-test/security || true
